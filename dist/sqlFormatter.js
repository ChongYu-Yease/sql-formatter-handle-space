!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash/trimEnd"),require("lodash/repeat"),require("lodash/last"),require("lodash/isEmpty"),require("lodash/escapeRegExp")):"function"==typeof define&&define.amd?define(["lodash/trimEnd","lodash/repeat","lodash/last","lodash/isEmpty","lodash/escapeRegExp"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).xuchongyu=t(e.trimEnd,e.repeat,e.last,e.isEmpty,e.escapeRegExp)}(this,(function(e,t,n,i,r){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=o(e),s=o(t),u=o(n),l=o(i),h=o(r),c={WHITESPACE:"whitespace",WORD:"word",STRING:"string",RESERVED:"reserved",RESERVED_TOPLEVEL:"reserved-toplevel",RESERVED_TOPLEVEL_INLINE:"reserved-toplevel-inline",UNION_WORDS:"union-words",RESERVED_NEWLINE:"reserved-newline",OPERATOR:"operator",OPEN_PAREN:"open-paren",CLOSE_PAREN:"close-paren",LINE_COMMENT:"line-comment",BLOCK_COMMENT:"block-comment",NUMBER:"number",PLACEHOLDER:"placeholder"},d=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var E="top-level",v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.indent=t||"  ",this.indentTypes=[]}return d(e,[{key:"setNoTrimEnd",value:function(){this.toTrimEnd=!1}},{key:"getTrimEnd",value:function(){return!!this.toTrimEnd||(this.toTrimEnd=!0,!1)}},{key:"setNoNewLine",value:function(){this.toStartNewLine=!1}},{key:"getStartNewLine",value:function(){return!!this.toStartNewLine||(this.toStartNewLine=!0,!1)}},{key:"setWhiteSpace",value:function(e){this.toSetWhiteSpace=e}},{key:"getWhiteSpace",value:function(){return this.toSetWhiteSpace}},{key:"getIndent",value:function(){return s.default(this.indent,this.indentTypes.length)}},{key:"increaseToplevel",value:function(){this.indentTypes.push(E)}},{key:"increaseBlockLevel",value:function(){this.indentTypes.push("block-level")}},{key:"decreaseTopLevel",value:function(){u.default(this.indentTypes)===E&&this.indentTypes.pop()}},{key:"decreaseBlockLevel",value:function(){for(;this.indentTypes.length>0;){if(this.indentTypes.pop()!==E)break}}}]),e}(),f=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.level=0}return f(e,[{key:"beginIfPossible",value:function(e,t){0===this.level&&this.isInlineBlock(e,t)?this.level=1:this.level>0?this.level++:this.level=0}},{key:"end",value:function(){this.level--}},{key:"isActive",value:function(){return this.level>0}},{key:"isInlineBlock",value:function(e,t){for(var n=0,i=0,r=t;r<e.length;r++){var o=e[r];if((n+=o.value.length)>200)return!1;if(o.type===c.OPEN_PAREN)i++;else if(o.type===c.CLOSE_PAREN&&0===--i)return!0;if(this.isForbiddenToken(o))return!1}return!1}},{key:"isForbiddenToken",value:function(e){var t=e.type,n=e.value;return t===c.RESERVED_TOPLEVEL||t===c.RESERVED_NEWLINE||t===c.COMMENT||t===c.BLOCK_COMMENT||";"===n}}]),e}(),k=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var g=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.params=t,this.index=0}return k(e,[{key:"get",value:function(e){var t=e.key,n=e.value;return this.params?t?this.params[t]:this.params[this.index++]:n}}]),e}(),y=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var R=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cfg=t||{},this.indentation=new v(this.cfg.indent),this.inlineBlock=new p,this.params=new g(this.cfg.params),this.tokenizer=n,this.previousReservedWord={},this.tokens=[],this.index=0}return y(e,[{key:"format",value:function(e){return this.tokens=this.tokenizer.tokenize(e),this.getFormattedQueryFromTokens().trim()}},{key:"getFormattedQueryFromTokens",value:function(){var e=this,t="";return this.tokens.forEach((function(n,i){e.index=i,n.type===c.WHITESPACE||(n.type===c.LINE_COMMENT?t=e.formatLineComment(n,t):n.type===c.BLOCK_COMMENT?t=e.formatBlockComment(n,t):n.type===c.RESERVED_TOPLEVEL?(t=e.formatToplevelReservedWord(n,t),e.previousReservedWord=n):n.type===c.RESERVED_NEWLINE?(t=e.formatNewlineReservedWord(n,t),(/^ADD JAR/i.test(n.value)||/^SET/i.test(n.value))&&e.indentation.setWhiteSpace(!1),e.previousReservedWord=n):n.type===c.RESERVED_TOPLEVEL_INLINE?(t=e.formatToplevelInLineReservedWord(n,t),e.previousReservedWord=n):n.type===c.UNION_WORDS?(t=e.formatUnionWords(n,t),e.previousReservedWord=n):n.type===c.RESERVED?(/^BETWEEN/i.test(n.value)&&e.indentation.setNoNewLine(),t=e.formaReserverdWords(n,t),e.previousReservedWord=n):n.type===c.OPEN_PAREN?t=e.formatOpeningParentheses(n,t):n.type===c.CLOSE_PAREN?t=e.formatClosingParentheses(n,t):n.type===c.PLACEHOLDER?t=e.formatPlaceholder(n,t):","===n.value?t=e.formatComma(n,t):":"===n.value||"."===n.value?t=e.formatWithoutSpaces(n,t):";"===n.value?(e.indentation.setWhiteSpace(!0),t=e.endCodeBlock(n,t)):t=e.formatWithSpaces(n,t))})),t}},{key:"formatLineComment",value:function(e,t){var n=this.followNonWhitespaceTokenIndex();if(","===n.token.value){var i=this.tokens[n.index];return this.tokens[n.index]=e,this.tokens[this.index]=i,this.formatComma(i,t)}return this.previousNonWhitespaceToken().type===c.UNION_WORDS?(t=a.default(t)+" "+e.value,this.indentation.setNoTrimEnd(),t):";"!==this.previousNonWhitespaceToken().value&&this.previousNonWhitespaceToken().type!==c.LINE_COMMENT?a.default(t)+" "+this.addNewline(e.value):this.addNewline(t)+this.addNewline(e.value)}},{key:"formatBlockComment",value:function(e,t){return this.addNewline(this.addNewline(t)+this.indentComment(e.value))}},{key:"indentComment",value:function(e){return e.replace(/\n/g,"\n"+this.indentation.getIndent())}},{key:"formatToplevelReservedWord",value:function(e,t){return this.indentation.decreaseTopLevel(),t=this.previousNonWhitespaceToken().type!==c.OPEN_PAREN?this.addNewline(t):a.default(t)+" ",this.indentation.increaseToplevel(),t+=this.equalizeWhitespace(e.value.toLowerCase()),this.addNewline(t)}},{key:"formatToplevelInLineReservedWord",value:function(e,t){return this.indentation.decreaseTopLevel(),t=this.addNewline(t),this.indentation.increaseToplevel(),(t+=this.equalizeWhitespace(e.value.toLowerCase()))+" "}},{key:"formatUnionWords",value:function(e,t){return this.indentation.setNoTrimEnd(),t=t+"\n"+this.indentation.getIndent(),this.indentation.decreaseTopLevel(),this.indentation.setNoTrimEnd(),t=(t=t+"\n"+this.indentation.getIndent())+e.value.toLowerCase()+"\n",this.indentation.setNoTrimEnd(),t}},{key:"formatNewlineReservedWord",value:function(e,t){return this.indentation.getStartNewLine()?this.addNewline(t)+this.equalizeWhitespace(e.value.toLowerCase())+" ":t+this.equalizeWhitespace(e.value.toLowerCase())+" "}},{key:"equalizeWhitespace",value:function(e){return e.replace(/\s+/g," ")}},{key:"formatOpeningParentheses",value:function(e,t){return this.previousNonWhitespaceToken().type===c.RESERVED_TOPLEVEL_INLINE||","===this.previousNonWhitespaceToken().value&&"case"===e.value.toLowerCase()?(t=this.addNewline(t)+e.value,this.indentation.increaseBlockLevel(),t):([c.WHITESPACE,c.OPEN_PAREN,c.LINE_COMMENT].includes(this.previousToken().type)||(t=a.default(t)),t+=e.value,this.inlineBlock.beginIfPossible(this.tokens,this.index),this.inlineBlock.isActive()||(this.indentation.increaseBlockLevel(),t=this.addNewline(t)),t)}},{key:"formatClosingParentheses",value:function(e,t){return this.inlineBlock.isActive()?(this.inlineBlock.end(),this.formatWithSpaceAfter(e,t)):(this.indentation.decreaseBlockLevel(),this.formatWithSpaces(e,this.addNewline(t)))}},{key:"formatPlaceholder",value:function(e,t){return t+this.params.get(e)+" "}},{key:"endCodeBlock",value:function(e,t){return t=t+e.value+"\n",this.indentation.setNoTrimEnd(),this.indentation.decreaseBlockLevel(),t}},{key:"formatComma",value:function(e,t){return t=this.trimTrailingWhitespace(t)+e.value+" ",this.inlineBlock.isActive()||/^LIMIT$/i.test(this.previousReservedWord.value)?t:this.addNewline(t)}},{key:"formatWithSpaceAfter",value:function(e,t){return this.trimTrailingWhitespace(t)+e.value+" "}},{key:"formatWithoutSpaces",value:function(e,t){return this.trimTrailingWhitespace(t)+e.value}},{key:"formaReserverdWords",value:function(e,t){return this.indentation.getWhiteSpace()?t+e.value.toLowerCase()+" ":t+e.value.toLowerCase()}},{key:"formatWithSpaces",value:function(e,t){return this.indentation.getWhiteSpace()?t+e.value+" ":t+e.value}},{key:"addNewline",value:function(e){return this.indentation.getTrimEnd()?a.default(e)+"\n"+this.indentation.getIndent():e+"\n"+this.indentation.getIndent()}},{key:"trimTrailingWhitespace",value:function(e){return this.previousNonWhitespaceToken().type===c.LINE_COMMENT?a.default(e)+"\n":a.default(e)}},{key:"previousNonWhitespaceToken",value:function(){for(var e=1;this.previousToken(e).type===c.WHITESPACE;)e++;return this.previousToken(e)}},{key:"previousToken",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.tokens[this.index-e]||{}}},{key:"followNonWhitespaceTokenIndex",value:function(){for(var e=1;this.followToken(e).type===c.WHITESPACE;)e++;return{token:this.followToken(e),index:this.index+e}}},{key:"followToken",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.tokens[this.index+e]||{}}}]),e}(),T=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var m=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.WHITESPACE_REGEX=/^(\s+)/,this.NUMBER_REGEX=/^((-\s*)?[0-9]+(\.[0-9]+)?|0x[0-9a-fA-F]+|0b[01]+)\b/,this.OPERATOR_REGEX=/^(!=|<>|==|<=|>=|!<|!>|\|\||::|->>|->|~~\*|~~|!~~\*|!~~|~\*|!~\*|!~|.)/,this.BLOCK_COMMENT_REGEX=/^(\/\*[^]*?(?:\*\/|$))/,this.LINE_COMMENT_REGEX=this.createLineCommentRegex(t.lineCommentTypes),this.RESERVED_TOPLEVEL_REGEX=this.createReservedWordRegex(t.reservedToplevelWords),this.RESERVED_NEWLINE_REGEX=this.createReservedWordRegex(t.reservedNewlineWords),this.RESERVED_PLAIN_REGEX=this.createReservedWordRegex(t.reservedWords),this.RESERVED_TOPLEVEL_INLINE_REGEX=this.createReservedWordRegex(t.reservedToplevelInLineWords),this.UNION_WORDS_REGEX=this.createReservedWordRegex(t.unionWords),this.WORD_REGEX=this.createWordRegex(t.specialWordChars),this.STRING_REGEX=this.createStringRegex(t.stringTypes),this.OPEN_PAREN_REGEX=this.createParenRegex(t.openParens),this.CLOSE_PAREN_REGEX=this.createParenRegex(t.closeParens),this.INDEXED_PLACEHOLDER_REGEX=this.createPlaceholderRegex(t.indexedPlaceholderTypes,"[0-9]*"),this.IDENT_NAMED_PLACEHOLDER_REGEX=this.createPlaceholderRegex(t.namedPlaceholderTypes,"[a-zA-Z0-9._$]+"),this.STRING_NAMED_PLACEHOLDER_REGEX=this.createPlaceholderRegex(t.namedPlaceholderTypes,this.createStringPattern(t.stringTypes))}return T(e,[{key:"createLineCommentRegex",value:function(e){return new RegExp("^((?:"+e.map((function(e){return h.default(e)})).join("|")+").*?(?:\n|$))")}},{key:"createReservedWordRegex",value:function(e){var t=e.join("|").replace(/ /g,"\\s+");return new RegExp("^("+t+")\\b","i")}},{key:"createWordRegex",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return new RegExp("^([\\w"+e.join("")+"]+)")}},{key:"createStringRegex",value:function(e){return new RegExp("^("+this.createStringPattern(e)+")")}},{key:"createStringPattern",value:function(e){var t={"``":"((`[^`]*($|`))+)","[]":"((\\[[^\\]]*($|\\]))(\\][^\\]]*($|\\]))*)",'""':'(("[^"\\\\]*(?:\\\\.[^"\\\\]*)*("|$))+)',"''":"(('[^'\\\\]*(?:\\\\.[^'\\\\]*)*('|$))+)","N''":"((N'[^N'\\\\]*(?:\\\\.[^N'\\\\]*)*('|$))+)"};return e.map((function(e){return t[e]})).join("|")}},{key:"createParenRegex",value:function(e){var t=this;return new RegExp("^("+e.map((function(e){return t.escapeParen(e)})).join("|")+")","i")}},{key:"escapeParen",value:function(e){return 1===e.length?h.default(e):"\\b"+e+"\\b"}},{key:"createPlaceholderRegex",value:function(e,t){if(l.default(e))return!1;var n=e.map(h.default).join("|");return new RegExp("^((?:"+n+")(?:"+t+"))")}},{key:"tokenize",value:function(e){for(var t=[],n=void 0;e.length;)n=this.getNextToken(e,n),e=e.substring(n.value.length),t.push(n);return t}},{key:"getNextToken",value:function(e,t){return this.getWhitespaceToken(e)||this.getCommentToken(e)||this.getStringToken(e)||this.getOpenParenToken(e)||this.getCloseParenToken(e)||this.getNumberToken(e)||this.getReservedWordToken(e,t)||this.getWordToken(e)||this.getOperatorToken(e)}},{key:"getWhitespaceToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.WHITESPACE,regex:this.WHITESPACE_REGEX})}},{key:"getCommentToken",value:function(e){return this.getLineCommentToken(e)||this.getBlockCommentToken(e)}},{key:"getLineCommentToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.LINE_COMMENT,regex:this.LINE_COMMENT_REGEX})}},{key:"getBlockCommentToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.BLOCK_COMMENT,regex:this.BLOCK_COMMENT_REGEX})}},{key:"getStringToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.STRING,regex:this.STRING_REGEX})}},{key:"getOpenParenToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.OPEN_PAREN,regex:this.OPEN_PAREN_REGEX})}},{key:"getCloseParenToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.CLOSE_PAREN,regex:this.CLOSE_PAREN_REGEX})}},{key:"getPlaceholderToken",value:function(e){return this.getIdentNamedPlaceholderToken(e)||this.getStringNamedPlaceholderToken(e)||this.getIndexedPlaceholderToken(e)}},{key:"getIdentNamedPlaceholderToken",value:function(e){return this.getPlaceholderTokenWithKey({input:e,regex:this.IDENT_NAMED_PLACEHOLDER_REGEX,parseKey:function(e){return e.slice(1)}})}},{key:"getStringNamedPlaceholderToken",value:function(e){var t=this;return this.getPlaceholderTokenWithKey({input:e,regex:this.STRING_NAMED_PLACEHOLDER_REGEX,parseKey:function(e){return t.getEscapedPlaceholderKey({key:e.slice(2,-1),quoteChar:e.slice(-1)})}})}},{key:"getIndexedPlaceholderToken",value:function(e){return this.getPlaceholderTokenWithKey({input:e,regex:this.INDEXED_PLACEHOLDER_REGEX,parseKey:function(e){return e.slice(1)}})}},{key:"getPlaceholderTokenWithKey",value:function(e){var t=e.input,n=e.regex,i=e.parseKey,r=this.getTokenOnFirstMatch({input:t,regex:n,type:c.PLACEHOLDER});return r&&(r.key=i(r.value)),r}},{key:"getEscapedPlaceholderKey",value:function(e){var t=e.key,n=e.quoteChar;return t.replace(new RegExp(h.default("\\")+n,"g"),n)}},{key:"getNumberToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.NUMBER,regex:this.NUMBER_REGEX})}},{key:"getOperatorToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.OPERATOR,regex:this.OPERATOR_REGEX})}},{key:"getReservedWordToken",value:function(e,t){if(!t||!t.value||"."!==t.value)return this.getToplevelReservedToken(e)||this.getToplevelInLineReservedToken(e)||this.getNewlineReservedToken(e)||this.getPlainReservedToken(e)||this.getUnionWordsToken(e)}},{key:"getToplevelReservedToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.RESERVED_TOPLEVEL,regex:this.RESERVED_TOPLEVEL_REGEX})}},{key:"getToplevelInLineReservedToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.RESERVED_TOPLEVEL_INLINE,regex:this.RESERVED_TOPLEVEL_INLINE_REGEX})}},{key:"getNewlineReservedToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.RESERVED_NEWLINE,regex:this.RESERVED_NEWLINE_REGEX})}},{key:"getUnionWordsToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.UNION_WORDS,regex:this.UNION_WORDS_REGEX})}},{key:"getPlainReservedToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.RESERVED,regex:this.RESERVED_PLAIN_REGEX})}},{key:"getWordToken",value:function(e){return this.getTokenOnFirstMatch({input:e,type:c.WORD,regex:this.WORD_REGEX})}},{key:"getTokenOnFirstMatch",value:function(e){var t=e.input,n=e.type,i=e.regex,r=t.match(i);if(r)return{type:n,value:r[1]}}}]),e}(),N=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var L=["as","asc","auto_increment","between","case","character set","charset","comment","contains","current_timestamp","current_date","count","coalesce","database","databases","default","delete","desc","describe","distinct","else","end","engine","exists","explain","fields","file","foreign","full","function","global","grant","grants","group_concat","hour","identified","if","ifnull","in","index","indexes","infile","insert","interval","into","invoker","is","key","keys","kill","like","match","minute","min","max","modify","month","names","now()","null","partition","partitions","regexp","rename","replace","replication","reset","rlike","row","rows","row_format","second","storage","string","sum","table","tables","temporary","terminated","then","to","true","truncate","type","types","uncommitted","unique","unsigned","usage","use","using","variables","view","when","with"],P=["delete from","except","group by","order by","having","intersect","modify","select","update","values"],_=["union all","union"],O=["use","drop table","create table","from","where","limit","create","insert overwrite","insert into","inner join","full join","full outer join","join","left join","left outer join","outer join","right join","right outer join","on"],W=["and","or","partitioned by","row format","fields terminated by","lines terminated by","stored as","tblproperties","alter table","add jar","after","alter column","cross apply","cross join","set","when","else"],w=void 0,C=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cfg=t}return N(e,[{key:"format",value:function(e){return w||(w=new m({reservedWords:L,reservedToplevelWords:P,reservedNewlineWords:W,reservedToplevelInLineWords:O,unionWords:_,stringTypes:['""',"N''","''","``","[]"],openParens:["(","CASE"],closeParens:[")","END"],indexedPlaceholderTypes:["?"],lineCommentTypes:["#","--"]})),new R(this.cfg,w).format(e)}}]),e}();return function(e){return new C({}).format(e)}}));
